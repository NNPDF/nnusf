# A Github workflow that runs the tests
name: Run unit tests

# Define events when the workflow should be triggered or
# manually triggered through the `workflow_dispatch`
on:
  push:
    branches: ["master"]
  pull_request:
    types:
      - closed
      - review_requested
  pull_request_review:
    types:
      - submitted
  workflow_dispatch:


jobs:
  test:
    name: üî¨ Test NNSFnu package üêç
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Python üêç
        id: setup-python
        uses: actions/setup-python@v2
        with:
          python-version: "3.9"

      - name: Install LHAPDF 6.4.0
        env:
          VERSION: 6.4.0
        run: |
          wget --no-verbose https://lhapdf.hepforge.org/downloads/?f=LHAPDF-${VERSION}.tar.gz -O LHAPDF-${VERSION}.tar.gz
          tar xzf LHAPDF-${VERSION}.tar.gz
          cd LHAPDF-${VERSION}
          ./configure --prefix=${HOME}/prefix --disable-static
          make -j
          make install
        shell: bash

      - name: Install and configure Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-path: ~/.virtualenvs
          installer-parallel: true

      - name: Cache Poetry virtualenv
        uses: actions/cache@v2
        id: cache
        with:
          path: ~/.virtualenvs
          key: ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-poetry-${{ hashFiles('poetry.lock') }}

      - name: Install version management tool
        run: |
          PIP="$(head -n1 $(which poetry) | cut -c 3-) -m pip"
          ${PIP} install poetry-dynamic-versioning

      - name: Install dependencies üì¶
        run: poetry install --no-interaction --no-root --with test
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Install task runner
        run: pip install poethepoet

      - name: Lint with pylint
        run: |
          poe lint
          poe lint-warnings

      - name: Test with pytest
        run: |
          poe test
