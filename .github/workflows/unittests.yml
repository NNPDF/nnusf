# A Github workflow that runs the tests
name: Run unit tests

# Define events when the workflow should be triggered or
# manually triggered through the `workflow_dispatch`
on:
  push:
    branches: ["master"]
  pull_request:
    types:
      - closed
      - review_requested
  pull_request_review:
    types:
      - submitted
  workflow_dispatch:


jobs:
  test:
    name: 🔬 Test NNSFnu package 🐍
    runs-on: ubuntu-latest
    env:
      python_version: "3.10"

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Python 🐍
        id: setup-python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ env.python_version }}

      - name: Install and configure Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-path: ~/.virtualenvs
          installer-parallel: true

      - name: Cache Poetry virtualenv
        uses: actions/cache@v2
        id: cache
        with:
          path: ~/.virtualenvs
          key: ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-poetry-${{ hashFiles('poetry.lock') }}

      - name: Install version management tool
        run: |
          PIP="$(head -n1 $(which poetry) | cut -c 3-) -m pip"
          ${PIP} install poetry-dynamic-versioning

      - name: Install dependencies 📦
        run: poetry install --no-interaction --no-root --with test
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Set Prefix global env
        run: echo "POE_PREFIX=$(poetry env info --path)" >> $GITHUB_ENV

      - name: Install composite LHAPDF
        uses: ./.github/actions/lhapdf
        with:
          prefix: ${{ env.POE_PREFIX }}
          pyversion: ${{ env.python_version }}

      - name: Install task runner
        run: pip install poethepoet

      - name: Lint with pylint
        run: |
          poe lint
          poe lint-warnings

      - name: Test with pytest
        run: |
          poe test
